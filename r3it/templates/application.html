{% extends "base.html" %}

{% block content %}

    <script src="https://polyfill.io/v3/polyfill.min.js?version=3.52.1&features=fetch"></script>
    <script src="https://js.stripe.com/v3/"></script>
    
    <script type="text/javascript">
        function ensureMemberIsNotContractor(lastChangedID) {
            // console.log(lastChangedID)

            // member = document.getElementById("emailMember").value;
            // contractor = document.getElementById("emailContact").value;
            // if (member == contractor) {
                
            //     alert("Member and contractor must be separate entities. If the member is performing the install, please selct 'Self-install' as the installation type")
                
            //     differentBlankVal = '';
            //     if (member == '') {differentBlankVal = ' ';}
            //     document.getElementById(lastChangedID).value = differentBlankVal;
            // }
        }
    </script>

    <meta id="dataTariff" data-tariff="{{default['Tariff']}}">

    <!-- Bootstrap application form -->
    <h1 class="my-4">New Interconnection Application</h1>
    <form id="application" action="{{formAction}}" method="post" class="needs-validation" novalidate>

        <hr class="my-4">

        <!-- Member Block -->
        <div id="member" class="mb-5">
            <h3 class="mb-3">Member Information</h3>
            <div class="row g-3 g-md-5">

                <div class="col-md-6 col-lg-7">
                    <div class="row g-3">
                        <div>
                            <label for="nameMember" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="nameMember" name="Name (Member)" value="{{default['Name (Member)']}}" placeholder="" required>
                        </div>
                        <fieldset>
                            <legend class="col-form-label py-0">Mailing Address</legend>
                            <div class="row g-2">
                                <div>
                                    <input type="text" class="form-control" id="addressMember" name="Address (Member)" value="{{default['Address (Member)']}}" placeholder="Street Address" aria-label="street address" required>
                                </div>
                                <div>
                                    <input type="text" class="form-control" id="address2Member" name="Address 2 (Member)" value="{{default['Address 2 (Member)']}}" placeholder="Address Line 2" aria-label="address line 2">
                                </div>
                                <div class="col-sm-6 col-md-12 col-lg-6">
                                    <input type="text" class="form-control" id="cityMember" name="City (Member)" value="{{default['City (Member)']}}" placeholder="City" aria-label="city" required>
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <select class="form-select" id="stateMember" name="State (Member)" aria-label="state" required>
                                        <option value="" hidden selected disabled>--State --</option>
                                        {% for state in states %}
                                            <option value="{{state}}" {% if (state == default['State (Member)']) %} selected {% endif %}>{{state}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <input type="text" class="form-control" id="zipMember" name="Zip (Member)" value="{{default['Zip (Member)']}}" placeholder="Postal / Zip Code" aria-label="zip code" pattern="[0-9]{5}" maxlength="5" required>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <!-- <div class="vr d-none d-md-inline-block px-0" style="margin-right: -1px; margin-left: -1px;"></div> -->

                <div class="col-md-6 col-lg-5">
                    <div class="row g-3">
                        <div>
                            <label for="emailMember" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="emailMember" name="Email (Member)" value="{{default['Email (Member)']}}" onchange="ensureMemberIsNotContractor(this.id)" required>
                        </div>
                        <div class="col-sm-4 col-md-12">
                            <label for="primaryPhoneMember" class="form-label">Primary Phone</label>
                            <input type="tel" class="form-control" id="primaryPhoneMember" name="Phone (Primary, Member)" value="{{default['Phone (Primary, Member)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16" required>
                        </div>
                        <div class="col-sm-4 col-md-12 col-lg-6">
                            <label for="secondaryPhoneMember" class="form-label">Secondary Phone</label>
                            <input type="tel" class="form-control" id="secondaryPhoneMember" name="Phone (Secondary, Member)" value="{{default['Phone (Secondary, Member)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16">
                        </div>
                        <div class="col-sm-4 col-md-12 col-lg-6">
                            <label for="faxMember" class="form-label">Fax Number</label>
                            <input type="tel" class="form-control" id="faxMember" name="Fax (Member)" value="{{default['Fax (Member)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-4">

        <div class="form-check my-4">
            <input type="checkbox" class="form-check-input no-validation" id="useAltContact" {% if (default['Name (Alt Contact)'] != '') %} checked {% endif %}>
            <label for="useAltContact" class="form-check-label">Use Alternate Contact</label>
        </div>

        <!-- Alternate Contact Block -->
        <div id="altContact" class="mb-5" {% if (default['Name (Alt Contact)'] == '') %} hidden {% endif %}>
            <h3 class="mb-3">Alternate Contact Information</h3>
            <div class="row g-3 g-md-5">

                <div class="col-md-6 col-lg-7">
                    <div class="row g-3">
                        <div>
                            <label for="nameAltContact" class="form-label">Contact Name</label>
                            <input type="text" class="form-control" id="nameAltContact" name="Name (Alt Contact)" value="{{default['Name (Alt Contact)']}}">
                        </div>
                        <fieldset>
                            <legend class="col-form-label py-0">Contact Address</legend>
                            <div class="row g-2">
                                <div>
                                    <input type="text" class="form-control" id="addressAltContact" name="Address (Alt Contact)" value="{{default['Address (Alt Contact)']}}" placeholder="Street Address" aria-label="street address">
                                </div>
                                <div>
                                    <input type="text" class="form-control" id="address2AltContact" name="Address 2 (Alt Contact)" value="{{default['Address 2 (Alt Contact)']}}" placeholder="Address Line 2" aria-label="address line 2">
                                </div>
                                <div class="col-sm-6 col-md-12 col-lg-6">
                                    <input type="text" class="form-control" id="cityAltContact" name="City (Alt Contact)" value="{{default['City (Alt Contact)']}}" placeholder="City" aria-label="city">
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <select class="form-select" id="stateAltContact" name="State (Alt Contact)" aria-label="alt contact state">
                                        <option value="" hidden selected disabled>--- State ---</option>
                                        {% for state in states %}
                                            <option value="{{state}}" {% if (state == default['State (Alt Contact)']) %} selected {% endif %}>{{state}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <input type="text" class="form-control" id="zipAltContact" name="Zip (Alt Contact)" value="{{default['Zip (Alt Contact)']}}" placeholder="Postal / Zip Code" aria-label="postal or zip code" pattern="[0-9]{5}" maxlength="5">
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-5">
                    <div class="row g-3">
                        <div>
                            <label for="emailAltContact" class="form-label">Email</label>
                            <input type="email" class="form-control" id="emailAltContact" name="Email (Alt Contact)" value="{{default['Email (Alt Contact)']}}" onchange="ensureMemberIsNotContractor(this.id)">
                        </div>
                        <div class="col-sm-4 col-md-12">
                            <label for="primaryPhoneAltContact" class="form-label">Primary Phone</label>
                            <input type="tel" class="form-control" id="primaryPhoneAltContact" name="Phone (Primary, Alt Contact)" value="{{default['Phone (Primary, Alt Contact)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16">
                        </div>
                        <div class="col-sm-4 col-md-12 col-lg-6">
                            <label for="secondaryPhoneAltContact" class="form-label">Secondary Phone</label>
                            <input type="tel" class="form-control" id="secondaryPhoneAltContact" name="Phone (Secondary, Alt Contact)" value="{{default['Phone (Secondary, Alt Contact)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16">
                        </div>
                        <div class="col-sm-4 col-md-12 col-lg-6">
                            <label for="faxAltContact" class="form-label">Fax Number</label>
                            <input type="tel" class="form-control" id="faxAltContact" name="Fax (Alt Contact)" value="{{default['Fax (Alt Contact)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Script to show/hide alt contact based on checkbox -->
        <script type="text/javascript">
            const useAltContact = document.getElementById("useAltContact")
            const altContact = document.getElementById("altContact")
            const requiredFields = ["name", "address", "city", "state", "zip", "email", "primaryPhone"]
            useAltContact.addEventListener("click", () => {
                if (useAltContact.checked) {
                    altContact.removeAttribute("hidden")
                    requiredFields.forEach((field) => {
                        document.getElementById(`${field}AltContact`).classList.add("required")
                    })
                } else {
                    altContact.setAttribute("hidden", "true")
                    requiredFields.forEach((field) => {
                        document.getElementById(`${field}AltContact`).classList.remove("required")
                    })
                }
            })
        </script>

        <hr class="my-4">

        <div class="form-check my-4">
            <input type="checkbox" class="form-check-input no-validation" id="memberIsSelfContractor">
            <label for="memberIsSelfContractor" class="form-check-label">Member is self-installing equipment</label>
        </div>

        <!-- Equipment Contractor Block -->
        <div id="contractor" class="mb-5">
            <h3 class="mb-3">Equipment Contractor Information</h3>
            <div class="row g-3 g-md-5">

                <div class="col-md-6 col-lg-7">
                    <div class="row g-3">
                        <div>
                            <label for="nameContractor" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="nameContractor" name="Name (Contractor)" value="{{default['Name (Contractor)']}}" required>
                        </div>
                        <div>
                            <label for="contactContractor" class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="contactContractor" name="Contact Person (Contractor)" value="{{default['Contact Person (Contractor)']}}" required>        
                        </div>
                        <fieldset>
                            <legend class="col-form-label py-0">Mailing Address</legend>
                            <div class="row g-2">
                                <div>
                                    <input type="text" class="form-control" id="addressContractor" name="Address (Contractor)" value="{{default['Address (Contractor)']}}" placeholder="Street Address" aria-label="street address" required>
                                </div>
                                <div>
                                    <input type="text" class="form-control" id="address2Contractor" name="Address 2 (Contractor)" value="{{default['Address 2 (Contractor)']}}" placeholder="Address Line 2" aria-label="address line 2">
                                </div>
                                <div class="col-sm-6 col-md-12 col-lg-6">
                                    <input type="text" class="form-control" id="cityContractor" name="City (Contractor)" value="{{default['City (Contractor)']}}" placeholder="City" aria-label="city" required>
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <select class="form-select" id="stateContractor" name="State (Contractor)" aria-label="contractor state" required>
                                        <option value="" hidden selected disabled>--- State ---</option>
                                        {% for state in states %}
                                            <option value="{{state}}" {% if (state == default['State (Contractor)']) %} selected {% endif %}>{{state}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <input type="text" class="form-control" id="zipContractor" name="Zip (Contractor)" value="{{default['Zip (Contractor)']}}" placeholder="Postal / Zip Code" aria-label="postal or zip code" pattern="[0-9]{5}" maxlength="5" required>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-5">
                    <div class="row g-3">
                        <div>
                            <label for="emailContractor" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="emailContractor" name="Email (Contractor)" value="{{default['Email (Contractor)']}}" onchange="ensureMemberIsNotContractor(this.id)" required>
                        </div>
                        <div class="col-sm-4 col-md-12">
                            <label for="primaryPhoneContractor" class="form-label">Primary Phone</label>
                            <input type="tel" class="form-control" id="primaryPhoneContractor" name="Phone (Primary, Contractor)" value="{{default['Phone (Primary, Contractor)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16" required>
                        </div>
                        <div class="col-sm-4 col-md-12 col-lg-6">
                            <label for="secondaryPhoneContractor" class="form-label">Secondary Phone</label>
                            <input type="tel" class="form-control" id="secondaryPhoneContractor" name="Phone (Secondary, Contractor)" value="{{default['Phone (Secondary, Contractor)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16">
                        </div>
                        <div class="col-sm-4 col-md-12 col-lg-6">
                            <label for="faxContractor" class="form-label">Fax Number</label>
                            <input type="tel" class="form-control" id="faxContractor" name="Fax (Contractor)" value="{{default['Fax (Contractor)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16">
                        </div>
                        <div class="">
                            <label for="docketNumber" class="form-label">Installer Certificate Docket Number</label>
                            <input type="text" class="form-control" id="docketNumber" name="Docket Number" value="{{default['Docket Number']}}" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-4">
        
        <div class="form-check my-3">
            <input type="checkbox" class="form-check-input no-validation" id="memberIsSelfElectrician">
            <label for="memberIsSelfElectrician" class="form-check-label">Member is self-installing electrical</label>
        </div>
        <div class="form-check mb-4">
            <input type="checkbox" class="form-check-input no-validation" id="contractorIsElectrician">
            <label for="contractorIsElectrician" class="form-check-label">Equipment contractor same as electrician</label>
        </div>

        <!-- Electrical Contractor Block -->
        <div id="electrician" class="mb-5">
            <h3 class="mb-3">Electrical Contractor Information</h3>

            <div class="row g-3 g-md-5">

                <div class="col-md-6 col-lg-7">
                    <div class="row g-3">
                        <div>
                            <label for="nameElectrician" class="form-label">Electrical Contractor Name</label>
                            <input type="text" class="form-control" id="nameElectrician" name="Name (Electrician)" value="{{default['Name (Electrician)']}}" required>
                        </div>
                        <div>
                            <label for="contactElectrician" class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="contactElectrician" name="Contact Person (Electrician)" value="{{default['Contact Person (Electrician)']}}" required>
                        </div>
                        <fieldset>
                            <legend class="col-form-label py-0">Mailing Address</legend>
                            <div class="row g-2">
                                <div>
                                    <input type="text" class="form-control" id="addressElectrician" name="Address (Electrician)" value="{{default['Address (Electrician)']}}" placeholder="Street Address" aria-label="street address" required>
                                </div>
                                <div>
                                    <input type="text" class="form-control" id="address2Electrician" name="Address 2 (Electrician)" value="{{default['Address 2 (Electrician)']}}" placeholder="Address Line 2" aria-label="address line 2">
                                </div>
                                <div class="col-sm-6 col-md-12 col-lg-6">
                                    <input type="text" class="form-control" id="cityElectrician" name="City (Electrician)" value="{{default['City (Electrician)']}}" placeholder="City" aria-label="city" required>
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <select class="form-select" id="stateElectrician" name="State (Electrician)" aria-label="electrician state" required>
                                        <option value="" hidden selected disabled>--- State ---</option>
                                        {% for state in states %}
                                            <option value="{{state}}" {% if (state == default['State (Electrician)']) %} selected {% endif %}>{{state}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <input type="text" class="form-control" id="zipElectrician" name="Zip (Electrician)" value="{{default['Zip (Electrician)']}}" placeholder="Postal / Zip Code" aria-label="postal or zip code" pattern="[0-9]{5}" maxlength="5" required>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-5">
                    <div class="row g-3">
                        <div>
                            <label for="emailElectrician" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="emailElectrician" name="Email (Electrician)" value="{{default['Email (Electrician)']}}" onchange="ensureMemberIsNotContractor(this.id)" required>
                        </div>
                        <div class="col-sm-4 col-md-12">
                            <label for="primaryPhoneElectrician" class="form-label">Primary Phone</label>
                            <input type="tel" class="form-control" id="primaryPhoneElectrician" name="Phone (Primary, Electrician)" value="{{default['Phone (Primary, Electrician)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16" required>
                        </div>
                        <div class="col-sm-4 col-md-12 col-lg-6">
                            <label for="secondaryPhoneElectrician" class="form-label">Secondary Phone</label>
                            <input type="tel" class="form-control" id="secondaryPhoneElectrician" name="Phone (Secondary, Electrician)" value="{{default['Phone (Secondary, Electrician)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16">
                        </div>
                        <div class="col-sm-4 col-md-12 col-lg-6">
                            <label for="faxElectrician" class="form-label">Fax Number</label>
                            <input type="tel" class="form-control" id="faxElectrician" name="Fax (Electrician)" value="{{default['Fax (Electrician)']}}" pattern="\([0-9]{3}\) [0-9]{3} - [0-9]{4}|[0-9]{10}" maxlength="16">
                        </div>
                        <fieldset>
                            <legend class="col-form-label py-0">Electrician License Number</legend>
                            <div class="row g-2">
                                <div class="col">
                                    <input type="text" class="form-control" id="licenseElectrician" name="License (Electrician)" value="{{default['License (Electrician)']}}" aria-label="electrician license number" required>
                                </div>
                                <div class="col-auto mt-auto ms-2">
                                    <div class="form-check mb-2">
                                        <input type="checkbox" class="form-check-input" id="activeLicense" name="Active License">
                                        <label for="activeLicense" class="form-check-label">Active License</label>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>

        <!-- Script to autofill contractor based on memberIsSelfContractor checkbox -->
        <script type="text/javascript">
            const memberIsSelfContractor = document.getElementById("memberIsSelfContractor")
            const memberIsSelfElectrician = document.getElementById("memberIsSelfElectrician")
            const contractorIsElectrician = document.getElementById("contractorIsElectrician")
            {
                const fields = ["name", "address", "address2", "city", "state", "zip", "primaryPhone", "secondaryPhone", "email", "fax"]
                const fieldPairs = fields.map((field) => [document.getElementById(`${field}Contractor`), document.getElementById(`${field}Member`)])
                fieldPairs[0] = [document.getElementById('contactContractor'), fieldPairs[0][1]]
                const nameContractor = document.getElementById('nameContractor')
                const inputHandlers = fieldPairs.map((pair) => () => pair[0].value = pair[1].value)
    
                memberIsSelfContractor.addEventListener("click", () => {
                    if (memberIsSelfContractor.checked) {
                        // for each contractor field, set val to member val
                        nameContractor.value = ""
                        fieldPairs.forEach((pair, i) => inputHandlers[i]())
                        // for each member field, add evt list to set contractor val to member val
                        fieldPairs.forEach((pair, i) => pair[1].addEventListener("input", inputHandlers[i]))
                        // for each contractor field, set disabled
                        nameContractor.setAttribute("disabled", "true")
                        fieldPairs.forEach((pair) => pair[0].setAttribute("disabled", "true"))
                        // disable contractorIsElectrician checkbox
                        contractorIsElectrician.setAttribute("disabled", "true")
                    } else {
                        // for each member field, remove evt list
                        fieldPairs.forEach((pair, i) => pair[1].removeEventListener("input", inputHandlers[i]))
                        // for each contractor field, set empty
                        fieldPairs.forEach((pair) => pair[0].value = "")
                        // for each contractor field, remove disabled
                        nameContractor.removeAttribute("disabled")
                        fieldPairs.forEach((pair) => pair[0].removeAttribute("disabled"))
                        // enable contractorIsElectrician checkbox
                        if (!memberIsSelfElectrician.checked) {
                            contractorIsElectrician.removeAttribute("disabled")
                        }
                    }
                })
            }
        </script>

        <!-- Script to autofill electrician based on contractorIsElectrician checkbox -->
        <script type="text/javascript">
            {
                const fields = ["name", "contact", "address", "address2", "city", "state", "zip", "primaryPhone", "secondaryPhone", "email", "fax"]
                const fieldPairs = fields.map((field) => [document.getElementById(`${field}Electrician`), document.getElementById(`${field}Contractor`)])
                const inputHandlers = fieldPairs.map((pair) => () => pair[0].value = pair[1].value)
    
                contractorIsElectrician.addEventListener("click", () => {
                    if (contractorIsElectrician.checked) {
                        // for each electrician field, set val to contractor val
                        fieldPairs.forEach((pair, i) => inputHandlers[i]())
                        // for each contractor field, add evt list to set electrician val to contractor val
                        fieldPairs.forEach((pair, i) => pair[1].addEventListener("input", inputHandlers[i]))
                        // for each electrician field, set disabled
                        fieldPairs.forEach((pair) => pair[0].setAttribute("disabled", "true"))
                        // disable memberIsSelfElectrician checkbox
                        memberIsSelfContractor.setAttribute("disabled", "true")
                        memberIsSelfElectrician.setAttribute("disabled", "true")
                    } else {
                        // for each contractor field, remove evt list
                        fieldPairs.forEach((pair, i) => pair[1].removeEventListener("input", inputHandlers[i]))
                        // for each electrician field, set empty
                        fieldPairs.forEach((pair) => pair[0].value = "")
                        // for each electrician field, remove disabled
                        fieldPairs.forEach((pair) => pair[0].removeAttribute("disabled"))
                        // enable memberIsSelfElectrician checkbox
                        memberIsSelfContractor.removeAttribute("disabled")
                        memberIsSelfElectrician.removeAttribute("disabled")
                    }
                })
            }
        </script>

        <!-- Script to autofill electrician based on memberIsSelfElectrician checkbox -->
        <script type="text/javascript">
            {
                const fields = ["name", "address", "address2", "city", "state", "zip", "primaryPhone", "secondaryPhone", "email", "fax"]
                const fieldPairs = fields.map((field) => [document.getElementById(`${field}Electrician`), document.getElementById(`${field}Member`)])
                fieldPairs[0] = [document.getElementById('contactElectrician'), fieldPairs[0][1]]
                const nameElectrician = document.getElementById('nameElectrician')
                const inputHandlers = fieldPairs.map((pair) => () => pair[0].value = pair[1].value)
    
                memberIsSelfElectrician.addEventListener("click", () => {
                    if (memberIsSelfElectrician.checked) {
                        // for each electrician field, set val to member val
                        nameElectrician.value = ""
                        fieldPairs.forEach((pair, i) => inputHandlers[i]())
                        // for each member field, add evt list to set electrician val to member val
                        fieldPairs.forEach((pair, i) => pair[1].addEventListener("input", inputHandlers[i]))
                        // for each electrician field, set disabled
                        nameElectrician.setAttribute("disabled", "true")
                        fieldPairs.forEach((pair) => pair[0].setAttribute("disabled", "true"))
                        // disable contractorIsElectrician checkbox
                        contractorIsElectrician.setAttribute("disabled", "true")
                    } else {
                        // for each member field, remove evt list
                        fieldPairs.forEach((pair, i) => pair[1].removeEventListener("input", inputHandlers[i]))
                        // for each electrician field, set empty
                        fieldPairs.forEach((pair) => pair[0].value = "")
                        // for each electrician field, remove disabled
                        nameElectrician.removeAttribute("disabled")
                        fieldPairs.forEach((pair) => pair[0].removeAttribute("disabled"))
                        // enable contractorIsElectrician checkbox
                        if (!memberIsSelfContractor.checked) {
                            contractorIsElectrician.removeAttribute("disabled")
                        }
                    }
                })
            }
        </script>

        <hr class="my-4">

        <!-- Interconnection Service Block -->
        <div id="facility" class="mb-5">
            <h3 class="mb-3">Interconnection Service Information</h3>
            <div class="row g-3 g-md-5">

                <div class="col-md-6 col-lg-7">
                    <div class="row g-3">
                        <div>
                            <label for="accountNumber" class="form-label">Member Account Number</label>
                            <input type="text" class="form-control" id="accountNumber" name="Account Number" value="{{default['Account Number']}}" required>
                        </div>
                        <div>
                            <label for="meterID" class="form-label">Meter ID</label>
                            <input type="text" class="form-control" id="meterID" name="Meter ID" value="{{default['Meter ID']}}" required>
                        </div>
                        <div>
                            <div class="row g-2 mb-2">
                                <label class="form-label col text-nowrap me-1 mb-0" for="owner">Property Owner</label>
                                <div class="form-check form-check-inline col-auto mt-auto mb-0 ms-1 me-0 pt-1">
                                    <input type="checkbox" class="form-check-input no-validation" id="memberIsOwner">
                                    <label for="memberIsOwner" class="form-check-label">Same as Member</label>
                                </div>
                            </div>
                            <input type="text" class="form-control" id="owner" name="Owner" value="{{default['Owner']}}" required>
                        </div>
                        <fieldset>
                            <div class="row g-2 mb-2">
                                <legend class="col-form-label py-0 col text-nowrap me-1">Service Address</legend>
                                <div class="form-check form-check-inline col-auto mt-auto mb-0 ms-1 me-0 pt-1">
                                    <input type="checkbox" class="form-check-input no-validation" id="serviceAddrIsMemberAddr">
                                    <label for="serviceAddrIsMemberAddr" class="form-check-label">Same as Member Address</label>
                                </div>
                            </div>
                            <div class="row g-2">
                                <div>
                                    <input type="text" class="form-control" id="addressService" name="Address (Service)" value="{{default['Address (Service)']}}" placeholder="Street Address" aria-label="street address" required>                                </div>
                                <div>
                                    <input type="text" class="form-control" id="address2Service" name="Address 2 (Service)" value="{{default['Address 2 (Service)']}}" placeholder="Address Line 2" aria-label="address line 2">
                                </div>
                                <div class="col-sm-6 col-md-12 col-lg-6">
                                    <input type="text" class="form-control" id="cityService" name="City (Service)" value="{{default['City (Service)']}}" placeholder="City" aria-label="city" required>
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <select class="form-select" id="stateService" name="State (Service)" aria-label="service location state" required>
                                        <option value="" hidden selected disabled>--- State ---</option>
                                        {% for state in states %}
                                            <option value="{{state}}" {% if (state == default['State (Service)']) %} selected {% endif %}>{{state}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6 col-sm-3 col-md-6 col-lg-3">
                                    <input type="text" class="form-control" id="zipService" name="Zip (Service)" value="{{default['Zip (Service)']}}" placeholder="Postal / Zip Code" aria-label="postal or zip code" pattern="[0-9]{5}" maxlength="5" required>
                                </div>
                            </div>
                        </fieldset>

                        <div class="col-sm-6 col-md-12 col-lg-6">
                            <label for="installDateEstimated" class="form-label">Estimated Install Date</label>
                            <input type="date" class="form-control" id="installDateEstimated" name="Estimated Install Date" value="{{default['Estimated Install Date']}}" required>
                        </div>
                        <div class="col-sm-6 col-md-12 col-lg-6">
                            <label for="inServiceDateEstimated" class="form-label">Estimated In-Service Date</label>
                            <input type="date" class="form-control" id="inServiceDateEstimated" name="Estimated In-Service Date" value="{{default['Estimated In-Service Date']}}" required>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-5">
                    <div class="row g-3">
                        <fieldset>
                            <legend class="col-form-label py-0">Inverter Manufacturer & Model</legend>
                            <div class="row g-2">
                                <div>
                                    <select class="form-select" id="inverter" aria-label="inverter manufacturer and model" required>
                                        <option value="" hidden selected disabled>--- Select Inverter ---</option>
                                        {% for manufacturer in inverters %}
                                            <optgroup label="{{manufacturer}}">
                                                {% for model in inverters[manufacturer] %}
                                                    <option value="{{model}}" {% if (default['Inverter Model'] == model) %} selected {% endif %}>{{model}}</option>
                                                {% endfor %}
                                            </optgroup>
                                        {% endfor %}
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-sm-6 col-md-12 col-lg-6 inverterOther" hidden>
                                    <input type="text" class="form-control" id="inverterManufacturer" name="Inverter Manufacturer" value="{{default['Inverter Manufacturer']}}" placeholder="Manufacturer" aria-label="inverter manufacturer">
                                </div>
                                <div class="col-sm-6 col-md-12 col-lg-6 inverterOther" hidden>
                                    <input type="text" class="form-control" id="inverterModel" name="Inverter Model" value="{{default['Inverter Model']}}" placeholder="Model" aria-label="inverter model">
                                </div>
                                <div class="inverterOther" hidden>
                                    <label for="inverterSpec" class="col-form-label">Specification Sheet</label>
                                    <input type="file" class="form-control" id="inverterSpec" name="Inverter Specification" placeholder="Specification Sheet" aria-label="inverter specification sheet">
                                </div>
                            </div>
                        </fieldset>
                        
                        <fieldset>
                            <legend class="col-form-label py-0">Nameplate Ratings</legend>
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="nameplateRatingkW" name="Nameplate Rating (kW)" value="{{default['Nameplate Rating (kW)']}}" aria-label="nameplate rating kilowatts AC" aria-describedby="kW-AC" required>
                                        <span class="input-group-text" id="kW-AC">kW-AC</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="nameplateRatingV" name="Nameplate Rating (V)" value="{{default['Nameplate Rating (V)']}}" aria-label="nameplate rating volts AC" aria-describedby="V-AC" required>
                                        <span class="input-group-text" id="V-AC">V-AC</span>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset class="col-6">
                            <legend class="col-form-label py-0">Inverter Phases</legend>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="onePhaseRadio" name="Phases" value="One" {% if (default['Phases'] == 'One') %} checked="True" {% endif %} required>
                                    <label for="onePhaseRadio" class="form-check-label">One</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="threePhaseRadio" name="Phases" value="Three" {% if (default['Phases']) == 'Three' %} checked="True" {% endif %} required>
                                    <label for="threePhaseRadio" class="form-check-label">Three</label>
                                </div>
                        </fieldset>
                        <fieldset class="col-6">
                            <legend class="col-form-label py-0">Is the equipment UL1741 listed?</legend>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="yesListedRadio" name="UL1741 listed" value="Yes" {% if (default['UL1741 listed'] == 'Yes') %} checked="True" {% endif %} required>
                                    <label for="yesListedRadio" class="form-check-label">Yes</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="noListedRadio" name="UL1741 listed" value="No" {% if (default['UL1741 listed'] == 'No') %} checked="True" {% endif %} required>
                                    <label for="noListedRadio" class="form-check-label">No</label>
                                </div>
                        </fieldset>

                        <fieldset class="col-6" id="tariffType">
                            <legend class="col-form-label py-0">Tariff Type</legend>
                            <div class="form-check form-check-inline">
                                <input type="radio" class="form-check-input" id="netMeteringRadio" name="Tariff" value="Net metering" required>
                                <label for="netMeteringRadio" class="form-check-label">Net metering</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input type="radio" class="form-check-input" id="valueOfEnergyRadio" name="Tariff" value="Value of energy" required>
                                <label for="valueOfEnergyRadio" class="form-check-label">Value of energy</label>
                            </div>
                        </fieldset>

                        <input type="hidden" class="form-control" id="installationType" name="Installation Type" value="{{default['Installation Type']}}" disabled>
                    </div>
                </div>
            </div>

            <!-- Owner same as member script -->
            <script type="text/javascript">
                const memberIsOwner = document.getElementById("memberIsOwner")
                const nameMember = document.getElementById("nameMember")
                const owner = document.getElementById("owner")
                
                const handleMemberInput = () => owner.value = nameMember.value

                memberIsOwner.addEventListener("click", () => {
                    if (memberIsOwner.checked) {
                        handleMemberInput()
                        nameMember.addEventListener("input", handleMemberInput)
                        owner.setAttribute("disabled", "true")
                    } else {
                        nameMember.removeEventListener("input", handleMemberInput)
                        owner.value = ""
                        owner.removeAttribute("disabled")
                    }
                })
            </script>

            <!-- Service address same as member address script -->
            <script type="text/javascript">
                const serviceAddrIsMemberAddr = document.getElementById("serviceAddrIsMemberAddr")
                const fields = ["address", "address2", "city", "state", "zip"]
                // array of array pairs of corresponding service and member fields
                // [[addressService, addressMember], [address2Service, addres2Member], [cityService, cityMember]...]
                const fieldPairs = fields.map((field) => [document.getElementById(`${field}Service`), document.getElementById(`${field}Member`)])
                const inputHandlers = fieldPairs.map((pair) => () => pair[0].value = pair[1].value)

                window.onload = () => {
                    if (fieldPairs.every((pair) => pair[0].value == pair[1].value)) {
                        serviceAddrIsMemberAddr.setAttribute("checked", "true")
                        fieldPairs.forEach((pair, i) => pair[1].addEventListener("input", inputHandlers[i]))
                        fieldPairs.forEach((pair) => pair[0].setAttribute("disabled", "true"))
                    }
                    // NOTE: Placed here until scripts condensed
                    if (nameMember.value == owner.value) {
                        memberIsOwner.setAttribute("checked", "true")
                        nameMember.addEventListener("input", handleMemberInput)
                        owner.setAttribute("disabled", "true")
                    }
                    const tariff = document.getElementById('dataTariff').dataset.tariff
                    if (tariff.startsWith("Net metering")) {
                        createResetMonthRadio()
                        netMeteringRadio.setAttribute("checked", "true")
                        if (tariff.includes("April")) {
                            document.querySelector("#aprilRadio").setAttribute("checked", "true")
                        } else if (tariff.includes("November")) {
                            document.querySelector("#novemberRadio").setAttribute("checked", "true")
                        }
                    } else {
                        valueOfEnergyRadio.setAttribute("checked", "true")
                    }
                }
                {
                    serviceAddrIsMemberAddr.addEventListener("click", () => {
                        if (serviceAddrIsMemberAddr.checked) {
                            // for each service field, set val to member val
                            fieldPairs.forEach((pair, i) => inputHandlers[i]())
                            // for each member field, add evt list to set service val to member val
                            fieldPairs.forEach((pair, i) => pair[1].addEventListener("input", inputHandlers[i]))
                            // for each service field, set disabled
                            fieldPairs.forEach((pair) => pair[0].setAttribute("disabled", "true"))
                        } else {
                            // for each member field, remove evt list
                            fieldPairs.forEach((pair, i) => pair[1].removeEventListener("input", inputHandlers[i]))
                            // for each service field, set empty
                            fieldPairs.forEach((pair) => pair[0].value = "")
                            // for each service field, remove disabled
                            fieldPairs.forEach((pair) => pair[0].removeAttribute("disabled"))
                        }
                    })
                }
            </script>

            <!-- Set constraints on date fields -->
            <script type="text/javascript">
                const today = new Date()
                const [year, month, date] = [today.getFullYear(), today.getMonth() + 1, today.getDate()]
                const todayString = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`
                const dates = document.querySelectorAll("input[type='date']")
                Array.prototype.forEach.call(dates, (date) => date.setAttribute("min", todayString))
            </script>

            <!-- Script to show/hide manufacturer and model fields based on dropdown -->
            <script type="text/javascript">
                const inverter = document.getElementById("inverter")
                const inverterManufacturer = document.getElementById("inverterManufacturer")
                const inverterModel = document.getElementById("inverterModel")
                const inverterOther = Array.from(document.getElementsByClassName("inverterOther"))
                
                // populates inverter field for saved inverter not in dropdown
                if ((inverterManufacturer.value || inverterModel.value) && inverter.selectedIndex == 0) {
                    inverter.value = "Other"
                    inverterOther.forEach((elem) => elem.removeAttribute("hidden"))
                }

                inverter.addEventListener("change", () => {
                    const selected = inverter[inverter.selectedIndex]
                    const optgroup = selected.parentNode.label

                    if (selected.value == "Other") {
                        inverterManufacturer.value = ""
                        inverterModel.value = ""
                        inverterOther.forEach((elem) => elem.removeAttribute("hidden"))
                    } else {
                        inverterManufacturer.value = optgroup
                        inverterModel.value = selected.value
                        inverterOther.forEach((elem) => elem.setAttribute("hidden", "true"))
                    }
                })
            </script>

            <!-- Script to remove or recreate April/Nov radio buttons on tariff button clicks -->
            <!-- Radio buttons could be hidden but not unchecked...bug? So remove them entirely to prevent submission of month with value of energy -->
            <script type="text/javascript">
                const tariffType = document.getElementById("tariffType")
                const netMeteringRadio = document.getElementById("netMeteringRadio")
                const valueOfEnergyRadio = document.getElementById("valueOfEnergyRadio")

                function createResetMonthRadio() {
                    netMeteringResetMonth = document.createElement("fieldset")
                    netMeteringResetMonth.className = "col-6"
                    netMeteringResetMonth.id = "netMeteringResetMonth"
                    
                    const legend = document.createElement("legend")
                    legend.className = "col-form-label py-0"
                    legend.textContent = "Net Metering kWh reset month"
                    netMeteringResetMonth.appendChild(legend)
                    
                    const aprilGroup = document.createElement("div")
                    aprilGroup.className = "form-check form-check-inline"
                    const aprilInput = document.createElement("input")
                    aprilInput.type = "radio"
                    aprilInput.className = "form-check-input"
                    aprilInput.id = "aprilRadio"
                    aprilInput.name = "Reset month"
                    aprilInput.value = "April kWh reset"
                    aprilInput.setAttribute("required", "true")
                    aprilGroup.appendChild(aprilInput)
                    const aprilLabel = document.createElement("label")
                    aprilLabel.htmlFor = "aprilRadio"
                    aprilLabel.className = "form-check-label"
                    aprilLabel.textContent = "April"
                    aprilGroup.appendChild(aprilLabel)
                    netMeteringResetMonth.appendChild(aprilGroup)
                    
                    const novemberGroup = document.createElement("div")
                    novemberGroup.className = "form-check form-check-inline"
                    const novemberInput = document.createElement("input")
                    novemberInput.type = "radio"
                    novemberInput.className = "form-check-input"
                    novemberInput.id = "novemberRadio"
                    novemberInput.name = "Reset month"
                    novemberInput.value = "November kWh reset"
                    novemberInput.setAttribute("required", "true")
                    novemberGroup.appendChild(novemberInput)
                    const novemberLabel = document.createElement("label")
                    novemberLabel.htmlFor = "novemberRadio"
                    novemberLabel.className = "form-check-label"
                    novemberLabel.textContent = "November"
                    novemberGroup.appendChild(novemberLabel)
                    netMeteringResetMonth.appendChild(novemberGroup)

                    tariffType.after(netMeteringResetMonth)
                }

                netMeteringRadio.addEventListener("click", () => {
                    const netMeteringResetMonth = document.querySelector("#netMeteringResetMonth")
                    if (!netMeteringResetMonth) {
                        createResetMonthRadio()
                    }
                })
                valueOfEnergyRadio.addEventListener("click", () => {
                    const netMeteringResetMonth = document.querySelector("#netMeteringResetMonth")
                    if (netMeteringResetMonth) {
                        netMeteringResetMonth.remove()
                    }
                })
            </script>
            
        </div>

        <hr class="my-4">

        <!-- Signature block -->
        <div id="signature" class="mb-5">
            <h3 class="mb-3">Terms</h3>
            <fieldset class="row g-3 g-lg-5 mb-5">
                <legend class="col-lg-7 col-form-label py-0 mb-2">
                    By clicking the checkbox and typing their name below, the applicant agrees to provide the Cooperative with any additional information required to complete the interconnection. The applicant shall operate his equipment within the guidelines set forth by the cooperative.
                </legend>
                <div class="col-md-6 col-lg-5">
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="agreement" name="Agreement" required>
                            <label for="agreement" class="form-check-label">I accept the terms above</label>
                            <div class="invalid-feedback">You must accept before submitting.</div>
                        </div>
                    </div>
                    <div>
                        <input type="text" class="form-control" id="signed" name="Signed" placeholder="Your name here" aria-label="signature" required>
                        <div class="invalid-feedback">Signature is required</div>
                    </div>
                </div>
            </fieldset>
        </div>

        <!-- Submit button -->
        <hr class="my-4">
        <div class="row my-5 justify-content-md-center">
            <div class="col-md-6">
                <button type="submit" class="btn btn-dark w-100" id="submit">
                    <span class="spinner-border spinner-border-sm me-2" id="submitSpinner" role="status" aria-hidden="true" hidden></span>
                    Submit Application
                </button>
            </div>
        </div>

        <!-- Script to display submit button spinner -->
        <!-- <script type="text/javascript">
            const submitSpinner = document.getElementById("submitSpinner")
            const submitButton = document.getElementById("submit")
            submitButton.addEventListener("click", () => {
                if (submitSpinner.hasAttribute("hidden")) {
                    submitSpinner.removeAttribute("hidden")
                }
                submitButton.childNodes[2].textContent = "Submitting Application..."
            })
        </script> -->

        <!-- Script to mask tel fields and zip codes -->
        <script src="https://unpkg.com/vanilla-masker@1.1.1/lib/vanilla-masker.js"></script>
        <script type="text/javascript">
            const tels = document.querySelectorAll("input[type='tel']")
            const zips = document.querySelectorAll("[id^='zip']")
            Array.prototype.forEach.call(tels, (tel) => {
                // NOTE: necessary here? why not place in elements?
                tel.placeholder = "(xxx) xxx - xxxx"
                VMasker(tel).maskPattern("(999) 999 - 9999")
            })
            Array.prototype.forEach.call(zips, (zip) => VMasker(zip).maskPattern("99999"))
        </script>

        <!-- Cleanup script on form submission -->
        <script type="text/javascript">
            function submitForm() {
                // submit button spinner
                const submitSpinner = document.getElementById("submitSpinner")
                const submitButton = document.getElementById("submit")
                submitSpinner.removeAttribute("hidden")
                submitButton.childNodes[2].textContent = "Submitting Application..."
                // unmasks tel and zip inputs
                const tels = document.querySelectorAll("input[type='tel']")
                const zips = document.querySelectorAll("[id^='zip']")
                Array.prototype.forEach.call(tels, (tel) => VMasker(tel).unMask())
                Array.prototype.forEach.call(zips, (zip) => VMasker(zip).unMask())
                // sets alt contact fields to empty if not checked
                const useAltContact = document.getElementById("useAltContact")
                const fields = ["name", "address", "address2", "city", "state", "zip", "primaryPhone", "secondaryPhone", "email", "fax"]
                const altContactFields = fields.map((field) => document.getElementById(`${field}AltContact`))
                if (!useAltContact.checked) {
                    altContactFields[4].childNodes[1].removeAttribute("disabled")   // required to actually save alt contact state empty string
                    altContactFields.forEach((field) => field.value = "")
                }
                // combines tariff and month radio buttons
                const netMeteringRadio = document.getElementById("netMeteringRadio")
                if (netMeteringRadio.checked) {
                    const aprilRadio = document.querySelector("#aprilRadio")
                    const novemberRadio = document.querySelector("#novemberRadio")
                    if (aprilRadio.checked) {
                        netMeteringRadio.value += " " + aprilRadio.value
                    } else if (novemberRadio.checked) {
                        netMeteringRadio.value += " " + novemberRadio.value
                    }
                    const netMeteringResetMonth = document.querySelector("#netMeteringResetMonth")
                    if (netMeteringResetMonth) {
                        netMeteringResetMonth.remove()
                    }
                }
                // combines checkboxes into installation type
                const installationType = document.querySelector("#installationType")
                const [selfCont, selfElec, contElec] = [memberIsSelfContractor.checked, memberIsSelfElectrician.checked, contractorIsElectrician.checked]
                installationType.value = (() => {
                    switch (true) {
                        case !selfCont && !selfElec && !contElec:
                            return "Contractor and Electrician"
                        case !selfCont && !selfElec && contElec:
                            return "Contractor only"
                        case !selfCont && selfElec && !contElec:
                            return "Contractor and Self-electric"
                        case selfCont && !selfElec && !contElec:
                            return "Self-install and Electrician"
                        case selfCont && selfElec && !contElec:
                            return "Self-install and Self-electric"
                    }
                })()
                const disabled = document.querySelectorAll(".form-control[disabled],.form-select[disabled]")
                Array.prototype.forEach.call(disabled, (field) => {
                    field.removeAttribute("disabled")
                })
            }

            const form = document.querySelector(".needs-validation")
            form.addEventListener("submit", (evt) => {
                if (!form.checkValidity()) {
                    evt.preventDefault()
                    evt.stopPropagation()
                } else {
                    submitForm()
                }
                form.classList.add("was-validated")
            }, false)
        </script>
    </form>
{% endblock %}